<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Applications Received</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet">
  <script src="../assets/js/include.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 1200px;
      margin-top: 80px;
    }
    .application-card {
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.05);
      transition: box-shadow 0.3s ease;
      position: relative;
    }
    .application-card:hover {
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    .stats-pill {
      font-size: 0.85rem;
      font-weight: 500;
      border-radius: 50px;
      padding: 0.35rem 0.75rem;
      margin-right: 0.5rem;
    }
    .rating-pill { background-color: #e0f7fa; color: #00796b; }
    .points-pill { background-color: #fff3e0; color: #ef6c00; }
    .rank-pill   { background-color: #ede7f6; color: #5e35b1; }
    .solved-pill { background-color: #e8f5e9; color: #388e3c; }
    .status-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.3rem 0.75rem;
      border-radius: 20px;
      color: #fff;
    }
    .status-rejected { background-color: #dc3545; }
    .status-scheduled { background-color: #198754; }
    .schedule-form { margin-top: 1rem; }
    .btn-disabled { opacity: 0.6; pointer-events: none; }
  </style>
</head>
<body>

  <div id="navbar-placeholder"></div>
  <script>includeHtml('navbar-placeholder', '../components/admin-navbar.html');</script>

  <div class="container">
    <h2 class="mb-4">Applications Received</h2>
    <div id="applications-container">
      <div class="text-center" id="loading">
        <div class="spinner-border text-primary" role="status"></div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
$(function() {
  async function loadApplications() {
    // Fetch applications + rankings in parallel
    const [appsRes, ranksRes] = await Promise.all([
      $.getJSON('http://localhost/Coders_Battleground/Server/get-company-applications.php'),
      $.getJSON('http://localhost/Coders_Battleground/Server/get_rankings.php')
    ]);
    $('#loading').remove();

    // No applications?
    if (appsRes.status !== 'success' || !appsRes.data.length) {
      return $('#applications-container')
        .html('<div class="alert alert-info">No applications received yet.</div>');
    }

    // Build a map from ranking response: email â†’ { rating, rank }
    const rankingMap = {};
    if (ranksRes.status === 'success') {
      ranksRes.data.forEach(u => {
        rankingMap[u.username] = { rating: u.rating, rank: u.rank };
      });
    }

    $('#applications-container').empty();

    // Render each user / application
    appsRes.data.forEach(user => {
      const userRank = rankingMap[user.email] || { rating: 'N/A', rank: 'N/A' };
      user.applications.forEach(app => {
        const status = app.job_status || 'Applied';
        const badgeClass = status === 'Rejected'
          ? 'status-rejected'
          : status === 'Scheduled'
            ? 'status-scheduled'
            : '';

        const card = $(`
          <div class="application-card">
            ${badgeClass
              ? `<span class="status-badge ${badgeClass}">${status}</span>`
              : ''
            }
            <h5>${user.name} <small class="text-muted">(${user.email})</small></h5>
            <p><strong>Applied for:</strong> ${app.position}</p>
            <p><strong>Location:</strong> ${app.location}</p>
            <div class="d-flex flex-wrap mt-3">
              <span class="stats-pill rating-pill">Rating: ${userRank.rating}</span>
              <span class="stats-pill rank-pill">Rank: ${userRank.rank}</span>
              <span class="stats-pill points-pill">Points: ${user.summary.total_solved}</span>
              <span class="stats-pill solved-pill">Solved: ${user.summary.total_solved}</span>
            </div>
            <div class="mt-3">
              <button class="btn btn-sm btn-outline-danger btn-reject">Reject</button>
              <button class="btn btn-sm btn-outline-success btn-schedule-toggle">Schedule</button>
            </div>
            <form class="schedule-form d-none">
              <div class="row g-2 align-items-center">
                <div class="col-auto">
                  <input type="datetime-local" class="form-control form-control-sm" name="start">
                </div>
                <div class="col-auto">
                  <input type="datetime-local" class="form-control form-control-sm" name="end">
                </div>
                <div class="col-auto">
                  <button type="submit" class="btn btn-sm btn-primary">Save</button>
                </div>
              </div>
            </form>
          </div>
        `);

        const $rejectBtn = card.find('.btn-reject');
        const $schedBtn  = card.find('.btn-schedule-toggle');
        const $form      = card.find('.schedule-form');
        const $badgeArea = card;

        // Initial button states from status
        if (status === 'Rejected') {
          $rejectBtn.addClass('btn-danger btn-disabled text-white').text('Rejected');
          $schedBtn.addClass('btn-disabled');
        }
        if (status === 'Scheduled') {
          $schedBtn
            .removeClass('btn-outline-success')
            .addClass('btn-success btn-disabled text-white')
            .text('Scheduled');
          $rejectBtn.addClass('btn-disabled');
        }

        // Reject handler
        $rejectBtn.click(async () => {
          await $.ajax({
            url: 'http://localhost/Coders_Battleground/Server/update-application-status.php',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
              interview_id: app.interview_id,
              user_email:   user.email,
              status:       'Rejected'
            })
          });
          $badgeArea.prepend(
            `<span class="status-badge status-rejected">Rejected</span>`
          );
          $rejectBtn
            .removeClass('btn-outline-danger')
            .addClass('btn-danger btn-disabled text-white')
            .text('Rejected');
          $schedBtn.addClass('btn-disabled');
        });

        // Toggle schedule form
        $schedBtn.click(() => $form.toggleClass('d-none'));

        // Submit schedule
        $form.submit(async e => {
          e.preventDefault();
          const start = $form.find('[name=start]').val();
          const end   = $form.find('[name=end]').val();
          await $.ajax({
            url: 'http://localhost/Coders_Battleground/Server/schedule-interview.php',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
              interview_id: app.interview_id,
              user_email:   user.email,
              start, end
            })
          });
          $badgeArea.prepend(
            `<span class="status-badge status-scheduled">Scheduled</span>`
          );
          $schedBtn
            .removeClass('btn-outline-success')
            .addClass('btn-success btn-disabled text-white')
            .text('Scheduled');
          $rejectBtn.addClass('btn-disabled');
          $form.addClass('d-none');
        });

        $('#applications-container').append(card);
      });
    });
  }

  loadApplications();
});
</script>

</body>
</html>
